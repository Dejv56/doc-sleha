<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_migration.xml" version="5.0" xml:id="cha-ha-migration">

 <title>Upgrading Your Cluster and Updating Software Packages</title>
 <info>
      <abstract>
        <para>
    This chapter covers two different scenarios: upgrading a cluster to
    another version of <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> (either a major release or a service
    pack) as opposed to updating individual packages on cluster nodes. See
    <xref linkend="sec-ha-migration-upgrade"/> versus
    <xref linkend="sec-ha-migration-update"/>.
   </para>
        <para>
    If you want to upgrade your cluster, check
    <xref linkend="sec-ha-migration-upgrade-oview"/> and
    <xref linkend="sec-ha-migration-upgrade-require"/> before starting
    to upgrade.
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>no</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-migration-terminology">
  <title>Terminology</title>

  <para>
   In the following, find definitions of the most important terms used in
   this chapter:
  </para>



  <variablelist>
   <varlistentry>
    <term>Major Release</term>
    <term>General Availability (GA) Version</term>
    <listitem>
     <para>
      A major release is a new product version that brings new features and
      tools, and decommissions previously deprecated components. It comes with
      backward incompatible changes.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-offline">
    <term>Cluster Offline Upgrade</term>
    <listitem>
     <para>
      If a new product version includes major changes that are backward
      incompatible, the cluster needs to be upgraded by a cluster offline
      upgrade. You need to take all nodes offline and upgrade the cluster as a whole,
      before you can bring all nodes back online.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-rolling">
    <term>Cluster Rolling Upgrade</term>
    <listitem>
     <para>
      In a cluster rolling upgrade one cluster node at a time is upgraded while the
      rest of the cluster is still running. You take the first node offline,
      upgrade it and bring it back online to join the cluster. Then you
      continue one by one until all cluster nodes are upgraded to a major
      version.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Service Pack (SP)</term>
    <listitem>
     <para>
      Combines several patches into a form that is easy to install or
      deploy. Service packs are numbered and usually contain security fixes,
      updates, upgrades, or enhancements of programs.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Update</term>
    <listitem>
     <para>
      Installation of a newer <emphasis>minor</emphasis> version of a
      package, which usually contains security fixes and other important fixes.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Upgrade</term>
    <listitem>
     <para>
      Installation of a newer <emphasis>major</emphasis> version of a
      package or distribution, which brings <emphasis>new
      features</emphasis>. See also <xref linkend="vle-upgrade-offline"/>
      versus <xref linkend="vle-upgrade-rolling"/>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-ha-migration-upgrade">
  <title>Upgrading your Cluster to the Latest Product Version</title>

  <para>
   Which upgrade path is supported, and how to perform the upgrade, depends
   on the current product version as well as on the target version you want
   to migrate to.
  </para>

  <para>
   The High Availability Extension has the same supported upgrade paths as the underlying base system. For a complete
   overview, see the section <link xlink:href="https://documentation.suse.com/sles/15-SP2/html/SLES-all/cha-upgrade-paths.html#sec-upgrade-paths-supported"><citetitle>Supported Upgrade Paths to SUSE Linux Enterprise Server <phrase role="productnumber"><phrase os="sles">15 SP2</phrase></phrase></citetitle></link> in the
   <citetitle>SUSE Linux Enterprise Server Upgrade Guide</citetitle>.
  </para>

  <para>
   In addition, the following rules apply, as the High Availability cluster stack offers two methods for
   upgrading the cluster:</para>
  <itemizedlist>
   <listitem>
    <formalpara>
     <title><xref linkend="vle-upgrade-rolling"/></title>
     <para>A cluster rolling upgrade is only supported within the same major release
      (from one service pack to the next, or from the GA version of a product to SP1).</para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title><xref linkend="vle-upgrade-offline" xrefstyle="select:label"/></title>
      <para>A cluster offline upgrade is required to upgrade from one major release to
      the next (for example, from SLE HA 12 to
      SLE HA 15) or from a service pack within one major
      release to the next major release (for example, from
      SLE HA 12 SP3 to SLE HA 15).
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>

  <para>
   <xref linkend="sec-ha-migration-upgrade-oview" xrefstyle="select:label"/>
   list the supported upgrade paths and methods for SLE HA (Geo),
   moving from one version to the next. The column <citetitle>For Details</citetitle> lists
   the specific upgrade documentation you should refer to (including also the base
   system and Geo Clustering for SUSE Linux Enterprise High Availability Extension). This documentation is available from:</para>
   <itemizedlist>
    <listitem>
     <para>
      <link xlink:href="https://documentation.suse.com/sles"/>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="https://documentation.suse.com/sle-ha"/>
     </para>
    </listitem>
   </itemizedlist>

  <important>
   <title>No Support for Mixed Clusters and Reversion After Upgrade</title>
   <itemizedlist>
    <listitem>
     <para>
      Mixed clusters running on <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12/<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 15 are
      <emphasis>not</emphasis> supported.
     </para>
    </listitem>
    <listitem>
     <para>
      After the upgrade process to product version 15, reverting back to
      product version 12 is <emphasis>not</emphasis> supported.
     </para>
    </listitem>
   </itemizedlist>
  </important>

  <sect2 xml:id="sec-ha-migration-upgrade-oview">
   <title>Supported Upgrade Paths for SLE HA and SLE HA Geo</title>
   <informaltable>
    <tgroup cols="3">
     <colspec colnum="1" colname="1" colwidth="28*"/>
     <colspec colnum="2" colname="2" colwidth="22*"/>
     <colspec colnum="3" colname="3" colwidth="50*"/>
     <thead>
      <row>
       <entry>
        <para>
         Upgrade From ... To
        </para>
       </entry>
       <entry>
        <para>
         Upgrade Path
        </para>
       </entry>
       <entry>
        <para>
         For Details
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         SLE HA 11 SP3 to
        </para>
       <para>SLE HA (Geo) 12</para>
       </entry>
       <entry>
        <para>
         Cluster Offline Upgrade
        </para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Deployment Guide</citetitle> for SLES 12, part
           <citetitle>Updating and Upgrading SUSE Linux Enterprise</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-offline" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <citetitle>Geo Clustering Quick Start</citetitle> for
           SLE HA 12, section <citetitle>Upgrading from
             SLE HA (Geo) 11 SP3 to
             SLE HA Geo 12</citetitle>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         SLE HA (Geo) 11 SP4 to
         SLE HA (Geo) 12 SP1
        </para>
       </entry>
       <entry>
        <para>
         Cluster Offline Upgrade
        </para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Deployment Guide</citetitle> for SLES 12 SP1,
           part <citetitle>Updating and Upgrading SUSE Linux Enterprise</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-offline" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <citetitle>Geo Clustering Quick Start</citetitle> for
           SLE HA 12 SP1,
           section <citetitle>Upgrading to the Latest Product Version</citetitle>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         SLE HA (Geo) 12 to
         SLE HA (Geo) 12 SP1
        </para>
       </entry>
       <entry>
        <para>
         Cluster Rolling Upgrade
        </para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Deployment Guide</citetitle> for SLES 12 SP1,
           part <citetitle>Updating and Upgrading SUSE Linux Enterprise</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <citetitle>Geo Clustering Quick Start</citetitle> for 
           SLE HA 12 SP1, section <citetitle>Upgrading to the
           Latest Product Version</citetitle>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 12 SP1 to
         SLE HA (Geo) 12 SP2</para>
       </entry>
       <entry>
        <para>Cluster Rolling Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Deployment Guide</citetitle> for SLES 12 SP2,
           part <citetitle>Updating and Upgrading SUSE Linux Enterprise</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <citetitle>Geo Clustering Quick Start</citetitle> for
           SLE HA 12 SP2, section <citetitle>Upgrading to the
           Latest Product Version</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>DRBD 8 to DRBD 9: <xref linkend="sec-ha-drbd-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 12 SP2 to
         SLE HA (Geo) 12 SP3</para>
       </entry>
       <entry>
        <para>Cluster Rolling Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Deployment Guide</citetitle> for SLES 12 SP3,
           part <citetitle>Updating and Upgrading SUSE Linux Enterprise</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <citetitle>Geo Clustering Guide</citetitle> for
           SLE HA 12 SP3, section <citetitle>Upgrading to the
           Latest Product Version</citetitle>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 12 SP3 to
         SLE HA (Geo) 12 SP4</para>
       </entry>
       <entry>
        <para>Cluster Rolling Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Deployment Guide</citetitle> for SLES 12 SP4,
           part <citetitle>Updating and Upgrading SUSE Linux Enterprise</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <citetitle>Geo Clustering Guide</citetitle> for
           SLE HA 12 SP4, section <citetitle>Upgrading to the
           Latest Product Version</citetitle>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 12 SP3 to
         SLE HA (Geo) 15</para>
       </entry>
       <entry>
        <para>Cluster Offline Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Upgrade Guide</citetitle> for SLES 15
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-offline-12-15" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
         <listitem>
          <para>Clustered LVM: <xref linkend="sec-ha-clvm-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 12 SP4 to
         SLE HA (Geo) 12 SP5</para>
       </entry>
       <entry>
        <para>Cluster Rolling Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Deployment Guide</citetitle> for SLES 12 SP5,
           part <citetitle>Updating and Upgrading SUSE Linux Enterprise</citetitle>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 12 SP4 to
         SLE HA (Geo) 15 SP1</para>
       </entry>
       <entry>
        <para>Cluster Offline Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Upgrade Guide</citetitle> for SLES 15 SP1
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-offline-12-15" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
         <listitem>
          <para>Clustered LVM: <xref linkend="sec-ha-clvm-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 12 SP5 to
         SLE HA (Geo) 15 SP2</para>
       </entry>
       <entry>
        <para>Cluster Offline Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Upgrade Guide</citetitle> for SLES 15 SP2
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-offline-12-15" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
         <listitem>
          <para>Clustered LVM: <xref linkend="sec-ha-clvm-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 15 to
         SLE HA (Geo) 15 SP1</para>
       </entry>
       <entry>
        <para>Cluster Rolling Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Upgrade Guide</citetitle> for
           SLES 15 SP1
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>SLE HA (Geo) 15 SP1 to
         SLE HA (Geo) 15 SP2</para>
       </entry>
       <entry>
        <para>Cluster Rolling Upgrade</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           Base System: <citetitle>Upgrade Guide</citetitle> for
           SLES 15 SP2
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA:
           <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo: <xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </informaltable>

   
   <note>
    <title>Skipping Service Packs</title>
    <para>
     The easiest upgrade path is consecutively installing all service packs.
     For the SUSE Linux Enterprise 15 product line (GA and the subsequent service packs) it is
     also supported to skip one service pack when upgrading. For example, upgrading from
     SLE HA 15 GA to 15 SP2 or from SLE HA 15 SP1
     to 15 SP3 is supported.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-require">
   <title>Required Preparations Before Upgrading</title>
   <variablelist>
    <varlistentry>
     <term>Backup</term>
     <listitem>
      <para>
       Ensure that your system backup is up to date and restorable.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Testing</term>
     <listitem>
      <para>
       Test the upgrade procedure on a staging instance of your cluster
       setup first, before performing it in a production environment.
       This gives you an estimation of the time frame required for the
       maintenance window. It also helps to detect and solve any unexpected
       problems that might arise.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-offline">
   <title>Cluster Offline Upgrade</title>
   <para>
    This section applies to the following scenarios:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Upgrading from SLE HA 11 SP3 to
      SLE HA 12—for details see
      <xref linkend="pro-ha-migration-offline"/>.</para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 11 SP4 to
      SLE HA 12 SP1—for details see
      <xref linkend="pro-ha-migration-offline"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 12 SP3 to
      SLE HA 15—for details see
      <xref linkend="pro-ha-migration-offline-12-15"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 12 SP4 to
      SLE HA 15 SP1—for details see
      <xref linkend="pro-ha-migration-offline-12-15"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 12 SP5 to
      SLE HA 15 SP2—for details see
      <xref linkend="pro-ha-migration-offline-12-15"/>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    If your cluster is still based on an older product version than the ones
    listed above, first upgrade it to a version of SLES and SLE HA
    that can be used as a source for upgrading to the desired target
    version.
   </para>

   <procedure xml:id="pro-ha-migration-offline">
    <title>Upgrading from Product Version 11 to 12: Cluster Offline Upgrade</title>
    <para>
     The High Availability Extension 12 cluster stack comes with major changes in various
     components (for example, <filename>/etc/corosync/corosync.conf</filename>, disk formats of OCFS2).
     Therefore, a <literal>cluster rolling upgrade</literal> from any <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>
     11 version is not supported. Instead, all cluster nodes must be offline
     and the cluster needs to be upgraded as a whole as described below.
    </para>
    <step>
     <para>
      Log in to each cluster node and stop the cluster stack with:
     </para>
<screen><prompt role="root">root # </prompt><command>rcopenais</command> stop</screen>
    </step>
    <step>
     <para>
      For each cluster node, perform an upgrade to the desired target
      version of SUSE Linux Enterprise Server and <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>—see <xref linkend="sec-ha-migration-upgrade-oview"/>.
     </para>
    </step>
    <step>
     <para>
      After the upgrade process has finished, reboot each node with the
      upgraded version of SUSE Linux Enterprise Server and <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>.
     </para>
    </step>
    <step>
     <para>
      If you use OCFS2 in your cluster setup, update the on-device structure
      by executing the following command:
     </para>
<screen><prompt role="root">root # </prompt><command>o2cluster</command> --update <replaceable>PATH_TO_DEVICE</replaceable></screen>
     <para>
      It adds additional parameters to the disk. They are needed for the
      updated OCFS2 version that is shipped with <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 and
      12 SPx.
     </para>
    </step>
    <step>
     <para>
      To update <filename>/etc/corosync/corosync.conf</filename> for Corosync version 2:
     </para>
     <substeps>
      <step>
       <para>
        Log in to one node and start the YaST cluster module.
       </para>
      </step>
      <step>
       <para>
        Switch to the <guimenu>Communication Channels</guimenu> category and
        enter values for the following new parameters: <guimenu>Cluster
        Name</guimenu> and <guimenu>Expected Votes</guimenu>. For details,
        see <xref linkend="pro-ha-installation-setup-channel1-udp"/>
        or <xref linkend="pro-ha-installation-setup-channel1-udpu"/>,
        respectively.
       </para>
       <para>
        If YaST should detect any other options that are invalid or
        missing according to Corosync version 2, it will prompt you to
        change them.
       </para>

      </step>
      <step>
       <para>
        Confirm your changes in YaST. YaST will write them to
        <filename>/etc/corosync/corosync.conf</filename>.
       </para>
      </step>
      <step>
       <para>
        If Csync2 is configured for your cluster, use the following command
        to push the updated Corosync configuration to the other cluster
        nodes:
       </para>
<screen><prompt role="root">root # </prompt><command>csync2</command> <option>-xv</option></screen>
       <para>
        For details on Csync2, see
        <xref linkend="sec-ha-installation-setup-csync2"/>.
       </para>
       <para>
        Alternatively, synchronize the updated Corosync configuration by
        manually copying <filename>/etc/corosync/corosync.conf</filename> to all cluster nodes.
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      Log in to each node and start the cluster stack with:
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
    </step>
    <step>
     <para>
      Check the cluster status with <command>crm status</command> or with
      Hawk2.
     </para>
    </step>
    <step>
     <para>Configure the following services to start at boot time:</para>
     <screen><prompt role="root">root # </prompt>systemctl enable pacemaker
<prompt role="root">root # </prompt>systemctl enable hawk
<prompt role="root">root # </prompt>systemctl enable sbd</screen>
    </step>
   </procedure>

 <note xml:id="note-ha-cib-upgrade">
    <title>Upgrading the CIB Syntax Version</title>
    <para>
     Sometimes new features are only available with the latest CIB syntax version.
     When you upgrade to a new product version, your CIB syntax version
     will <emphasis>not</emphasis> be upgraded by default.
     </para>
    <procedure>
     <step>
      <para>Check your version with:</para>
<screen>cibadmin -Q | grep validate-with</screen>
     </step>
     <step>
      <para>Upgrade to the latest CIB syntax version with:
      </para>
<screen><prompt role="root">root # </prompt><command>cibadmin</command> --upgrade --force</screen>
     </step>
    </procedure>
   </note>

<procedure xml:id="pro-ha-migration-offline-12-15">
    <title>Upgrading from Product Version 12 to 15: Cluster Offline Upgrade</title>
   <important>
     <title>Installation from Scratch</title>
     <para>If you decide to install the cluster nodes from scratch (instead
      of upgrading them), see <xref linkend="sec-ha-requirements-sw"/> for the
      list of modules required for <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> <phrase role="productnumber"><phrase os="sles">15 SP2</phrase></phrase>. Find more
      information about modules, extensions and related products in the release
      notes for SUSE Linux Enterprise Server 15. They are available at <link xlink:href="https://www.suse.com/releasenotes/"/>.
     </para>
    </important>
    <step>
     <para>
      Before starting the offline upgrade to <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 15, manually
      upgrade the CIB syntax in your current cluster as described in
      <xref linkend="note-ha-cib-upgrade"/>.
     </para>
    </step>
    <step>
     <para>
      Log in to each cluster node and stop the cluster stack with:
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
    </step>
    <step>
     <para>
      For each cluster node, perform an upgrade to the desired target
      version of SUSE Linux Enterprise Server and <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>—see <xref linkend="sec-ha-migration-upgrade-oview"/>.
     </para>
    </step>
    <step>
     <para>
      After the upgrade process has finished, log in to each node and boot it with the
      upgraded version of SUSE Linux Enterprise Server and <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>.
     </para>
    </step>
    <step>
     <para>If you use Cluster LVM, you need to migrate from clvmd to lvmlockd.
      See the man page of <command>lvmlockd</command>, section
      <citetitle>changing a clvm VG to a lockd VG</citetitle> and <xref linkend="sec-ha-clvm-migrate"/>.
     </para>
    </step>
    <step>
     <para>
      Start the cluster stack with:
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
    </step>
    <step>
     <para>
      Check the cluster status with <command>crm status</command> or with
      Hawk2.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-rolling">
   <title>Cluster Rolling Upgrade</title>
   <para>
    This section applies to the following scenarios:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Upgrading from SLE HA 12 to SLE HA 12 SP1
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 12 SP1 to
      SLE HA 12 SP2
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 12 SP2 to
      SLE HA 12 SP3
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 12 SP3 to
      SLE HA 12 SP4
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 12 SP4 to
      SLE HA 12 SP5
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 15 to
      SLE HA 15 SP1
     </para>
    </listitem>
    <listitem>
     <para>
      Upgrading from SLE HA 15 SP1 to
      SLE HA 15 SP2
     </para>
    </listitem>

   </itemizedlist>

   <para>Use one of the following procedures for your scenario:</para>
   <itemizedlist>
    <listitem>
     <para>
      For a more general rolling upgrade, refer to <xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:label"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      For a specific rolling upgrade, refer to <xref linkend="pro-ha-migration-rolling-upgrade-newsp-freshinstall" xrefstyle="select:label"/>.
     </para>
    </listitem>
   </itemizedlist>

   <warning>
    <title>Active Cluster Stack</title>
    <para>
     Before starting an upgrade for a node, <emphasis>stop</emphasis> the
     cluster stack <emphasis>on that node</emphasis>.
    </para>
    <para>
     If the cluster resource manager on a node is active during the software
     update, this can lead to unpredictable results like fencing of active
     nodes.
    </para>
   </warning>
   <important>
    <title>Time Limit for Cluster Rolling Upgrade</title>
    <para>
     The new features shipped with the latest product version will only be
     available after <emphasis>all</emphasis> cluster nodes have been
     upgraded to the latest product version. Mixed version clusters are only
     supported for a short time frame during the cluster rolling upgrade. Complete
     the cluster rolling upgrade within one week.
    </para>
    <para>
     Once all the online nodes are running the upgraded version, it is not
     possible for any other nodes with the old version to (re-)join without
     having been upgraded.
    </para>
   </important>
   <procedure xml:id="pro-ha-migration-rolling-upgrade">
    <title>Performing a Cluster Rolling Upgrade</title>

    <step>
     <para>
      Log in as <systemitem class="username">root</systemitem> on the node that you want to upgrade and stop the
      cluster stack:
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
    </step>
    <step xml:id="step-ha-migration-upgrade-tolatest">
     <para>
      Perform an upgrade to the desired target version of SUSE Linux Enterprise Server and
      <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>. To find the details for the individual upgrade
      processes, see
      <xref linkend="sec-ha-migration-upgrade-oview"/>.
     </para>
    </step>
    <step xml:id="step-ha-migration-upgrade-ais">
     <para>
      Start the cluster stack on the upgraded node to make the node rejoin
      the cluster:
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
    </step>
    <step>
     <para>
      Take the next node offline and repeat the procedure for that node.
     </para>
    </step>
    <step>
     <para>
      Check the cluster status with <command>crm status</command> or with
      Hawk2.
     </para>
     <para>
      The Hawk2 <guimenu>Status</guimenu> screen also shows a warning if
      different CRM versions are detected for your cluster nodes.
     </para>
    </step>
   </procedure>
   <important>
    <title>Time Limit for Rolling Upgrade</title>
    <para>
     The new features shipped with the latest product version will only be
     available after <emphasis>all</emphasis> cluster nodes have been
     upgraded to the latest product version. Mixed version clusters are only
     supported for a short time frame during the rolling upgrade. Complete
     the rolling upgrade within one week.
    </para>
   </important>
   <para>The Hawk2 <guimenu>Status</guimenu> screen also shows a warning if
    different CRM versions are detected for your cluster nodes.</para>
   <para>Beside an in-place upgrade, many customers prefer a fresh installation
    even for moving to the next service pack. The following procedure shows a
    scenario where a two-node cluster with the nodes alice and bob is
    upgraded to the next service pack (SP):
   </para>
   <procedure xml:id="pro-ha-migration-rolling-upgrade-newsp-freshinstall">
    <title>Performing a Cluster-wide Fresh Installation of a New Service Pack</title>
    <step xml:id="st-ha-migration-rolling-up-sp-backup">
     <para>Make a backup of your cluster configuration. A minimum set of files
      are shown in the following list:
     </para>
     
     <screen>/etc/corosync/corosync.conf
/etc/corosync/authkey
/etc/sysconfig/sbd
/etc/modules-load.d/watchdog.conf
/etc/hosts
/etc/ntp.conf</screen>
     
     <para>Depending on your resources, you may also need the following files:</para>
     
     <screen>/etc/services
/etc/passwd
/etc/shadow
/etc/groups
/etc/drbd/*
/etc/lvm/lvm.conf
/etc/mdadm.conf
/etc/mdadm.SID.conf</screen>
     
    </step>
    <step xml:id="st-ha-migration-rolling-alice">
     <para>Start with node alice.
     </para>
     <substeps>
      <step>
       <para>
        Put the node into standby node. That way, resources can move off the node:
       </para>
       <screen><prompt role="root">root # </prompt><command>crm</command> --wait node standby alice reboot</screen>
       <para>
        With the option <option>--wait</option>, the command returns only when
        the cluster finishes the transition and becomes idle.
        The <option>reboot</option> option has the effect that the node will
        be already out of standby mode when it is online again.
        Despite its name, the <option>reboot</option> option works as long
        as the node goes offline and online.
       </para>
      </step>
      <step>
       <para>Stop the cluster services on node alice:</para>
       <screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
      </step>
      <step>
       <para>
        At this point, alice does not have running resources anymore.
        Upgrade the node alice and reboot it afterward.
        Cluster services are assumed not to start on boot.
       </para>
      </step>
      <step>
       <para>
        Copy your backup files from <xref linkend="st-ha-migration-rolling-up-sp-backup"/>
        to the original places.
       </para>
      </step>
      <step>
       <para>Bring back node alice into cluster:</para>
       <screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
      </step>
      <step>
       <para>Check that resources are fine.</para>
      </step>
     </substeps>
    </step>
    <step>
     <para>Repeat <xref linkend="st-ha-migration-rolling-alice"/> for node
      bob.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-ha-migration-update">
  <title>Updating Software Packages on Cluster Nodes</title>

  <warning>
   <title>Active Cluster Stack</title>
   <para>
    Before starting a package update for a node, either <emphasis>stop</emphasis>
    the cluster stack <emphasis>on that node</emphasis> or put the
    <emphasis>node into maintenance mode</emphasis>, depending on whether the
    cluster stack is affected or not. See <xref linkend="step-update-check"/>
    for details.
   </para>
   <para>
    If the cluster resource manager on a node is active during the software
    update, this can lead to unpredictable results like fencing of active
    nodes.
   </para>
  </warning>

  <procedure>
   <step xml:id="step-update-check">
    <para>
     Before installing any package updates on a node, check the following:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Does the update affect any packages belonging to <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> or Geo Clustering for SUSE Linux Enterprise High Availability Extension?
       If <literal>yes</literal>: Stop the cluster stack on
       the node before starting the software update:
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
     </listitem>
     <listitem>
      <para>
       Does the package update require a reboot? If <literal>yes</literal>:
       Stop the cluster stack on the node before starting the software
       update:
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
     </listitem>
     <listitem>
      <para>
       If none of the situations above apply, you do not need to stop the
       cluster stack. In that case, put the node into maintenance mode
       before starting the software update:
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> node maintenance <replaceable>NODE_NAME</replaceable></screen>
      <para>
       For more details on maintenance mode, see
       <xref linkend="sec-ha-maint-overview"/>.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Install the package update using either YaST or Zypper.
    </para>
   </step>
   <step>
    <para>
     After the update has been successfully installed:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Either start the cluster stack on the respective node (if you
       stopped it in <xref linkend="step-update-check"/>):
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
     </listitem>
     <listitem>
      <para>
       or remove the maintenance flag to bring the node back to
       normal mode:
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> node ready <replaceable>NODE_NAME</replaceable></screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     Check the cluster status with <command>crm status</command> or with
     Hawk2.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-migration-more">
  <title>For More Information</title>

  <para>
   For detailed information about any changes and new features of the
   product you are upgrading to, refer to its release notes. They are
   available from <link xlink:href="https://www.suse.com/releasenotes/"/>.
  </para>
 </sect1>
</chapter>
