<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_resources_i.xml" version="5.0" xml:id="sec-ha-geo-rsc">
 <title>配置群集资源和约束</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>编辑</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>
  除了定义特定群集设置所需的资源和约束外，地域群集还需要下文所述的其他资源和约束。可按以下示例中所示使用 crm 外壳 (crmsh) 或者使用 HA Web Konsole (Hawk2) 来配置这些资源和约束。
 </para>

 <para>
  本节重点介绍特定于地域群集的任务。有关首选群集管理工具的介绍以及有关如何使用该工具配置资源和约束的一般指导，请参见 <link xlink:href="http://www.suse.com/documentation/"/> 上的《<citetitle><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 管理指南</citetitle>》中的下列章节之一：
 </para>

 <itemizedlist>
  <listitem>
   <para>
    Hawk2：“<citetitle>配置和管理群集资源（Web 界面）</citetitle>”一章
   </para>
  </listitem>
  <listitem>
   <para>
    crmsh：“<citetitle>配置和管理群集资源（命令行）</citetitle>”一章
   </para>
  </listitem>
 </itemizedlist>

 <important>
  <title>不跨站点进行 CIB 同步</title>
  <para>
   CIB <emphasis>不会</emphasis>跨地域群集的群集站点自动同步。这意味着，需要相应地为每个站点配置必须在整个地域群集中高度可用的所有资源。
  </para>
  <para>
   要简化将配置传输到其他群集站点的过程，可按这种方式配置具有站点特定参数的所有资源：使参数的值依赖于运行资源的群集站点的名称。
  </para>
  <para>
   为了实现此目的，必须在相应的 <filename>/etc/corosync/corosync.conf</filename> 文件中定义每个站点的群集名称。例如，站点 1 (<literal>amsterdam</literal>) 的 <filename>/etc/corosync/corosync.conf</filename> 必须包含以下项：
  </para>
<screen>totem {
   [...]
   cluster_name: amsterdam
   }</screen>
  <para>
   在一个站点上配置资源后，可以标记所有群集站点上所需的资源，从当前 CIB 导出这些资源，然后将其导入另一站点的 CIB。有关细节，请参见<xref linkend="sec-ha-geo-rsc-sync-cib"/>。
  </para>
 </important>

 <sect2 xml:id="sec-ha-geo-rsc-drbd">
  <title>DRBD 的资源和约束</title>
  <para>
   要完成 DRBD 设置，需要按<xref linkend="pro-ha-geo-rsc-drbd" xrefstyle="select:label"/>中所示配置某些资源和约束，然后按<xref linkend="sec-ha-geo-rsc-sync-cib"/>中所述将其传输到其他群集站点。
  </para>
  <procedure xml:id="pro-ha-geo-rsc-drbd">
   <title>为 DRBD 设置配置资源</title>
   <step>
    <para>
     在群集 <literal>amsterdam</literal> 的其中一个节点上，启动外壳并以 <systemitem class="username">root</systemitem> 或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     输入 <command>crm configure</command> 切换到交互式 crm 外壳。
    </para>
   </step>
   <step>
    <para>
     将 NFS 的（站点相关）服务 IP 配置为基本原始资源：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip_nfs ocf:heartbeat:IPaddr2 \
  params iflabel="nfs" nic="eth1" cidr_netmask="24"
  params rule #cluster-name eq amsterdam ip="192.168.201.151" \
  params rule #cluster-name eq berlin ip="192.168.202.151" \
  op monitor interval=10</screen>
   </step>
   <step>
    <para>
     配置文件系统资源以及 NFS 服务器的资源：
    </para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> nfs_fs ocf:heartbeat:Filesystem \
  params device="/dev/drbd/by-res/nfs/0" directory="/mnt/nfs" \
  fstype="ext4"
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> nfs_service systemd:nfs-server</screen>
   </step>
   <step>
    <para>
     为 DRBD 配置以下原始资源和多状态资源：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> drbd_nfs ocf:linbit:drbd \
  params drbd_resource="nfs-upper" \
  op monitor interval="31" role="Slave" \
  op monitor interval="30" role="Master"
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> drbd_nfs_lower ocf:linbit:drbd \
  params rule #cluster-name eq amsterdam \
  drbd_resource="nfs-lower-amsterdam" \
  params rule #cluster-name eq berlin \
  drbd_resource="nfs-lower-berlin" \                                
  op monitor interval="31" role="Slave" \
  op monitor interval="30" role="Master"
<prompt role="custom">crm(live)configure# </prompt><command>ms</command> ms_drbd_nfs drbd_nfs \
  meta master-max="1" master-node-max="1" \
  clone-max="1" clone-node-max="1" notify="true"
<prompt role="custom">crm(live)configure# </prompt><command>ms</command> ms_drbd_nfs_lower drbd_nfs_lower \
  meta master-max="1" master-node-max="1" \
  clone-max="2" clone-node-max="1" notify="true"</screen>
   </step>
   <step>
    <para>
     添加具有以下共置约束和顺序约束的组：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>group</command> g_nfs nfs_fs nfs_service
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_ip_with_lower \
   inf: ip_nfs:Started  ms_drbd_nfs_lower:Master
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_g_with_upper \
   inf: g_nfs:Started  ms_drbd_nfs:Master
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_upper_with_ip \
   inf: ms_drbd_nfs:Master  ip_nfs:Started
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_lower_drbd_before_ip_nfs \
   inf: ms_drbd_nfs_lower:promote  ip_nfs:start
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_ip_nfs_before_drbd \
   inf: ip_nfs:start  ms_drbd_nfs:promote
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_drbd_nfs_before_svc \
   inf: ms_drbd_nfs:promote  g_nfs:start</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 复查更改。
    </para>
   </step>
   <step>
    <para>
     如果全部都正确，请使用 <command>commit</command> 提交更改，并使用 <command>exit</command> 退出 crm 当前配置。
    </para>
    <para>
     配置将保存到 CIB。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-ha-geo-rsc-booth">
  <title>booth 的票据依赖性、约束和资源</title>
  <para>
   要完成 booth 设置，需要执行以下步骤来配置 booth 和资源故障转移所需的资源与约束：
  </para>
  <itemizedlist>
   <listitem>
    <para>

     <xref linkend="pro-ha-geo-setup-rsc-constraints" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>

     <xref linkend="pro-ha-geo-setup-rsc-boothd" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>

     <xref linkend="pro-ha-geo-setup-rsc-order" xrefstyle="select:title"/>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   需要在每个群集站点上提供资源配置。按<xref linkend="sec-ha-geo-rsc-sync-cib"/>中所述，将配置传输到其他站点。
  </para>
  <procedure xml:id="pro-ha-geo-setup-rsc-constraints">
   <title>配置资源的票据依赖性</title>
   <para>
     对于地域群集，可以指定哪些资源依赖于特定的票据。您可以与特定类型的约束一起，设置<literal>丢失策略</literal>，该策略定义撤消票据时应对相应资源采取哪些操作。<literal>loss-policy</literal> 属性可能具有以下值：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <literal>fence</literal>：屏蔽运行相关资源的节点。
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>stop</literal>：停止相关资源。
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>freeze</literal>：不对相关资源执行任何操作。
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>demote</literal>：将以 <literal>master</literal> 模式运行的相关资源降级为以 <literal>slave</literal> 模式运行。
      </para>
     </listitem>
    </itemizedlist> 
   <step>
    <para>
     在群集 amsterdam 的其中一个节点上，启动外壳并以 <systemitem class="username">root</systemitem> 或同等身份登录。

    </para>
   </step>
   <step>
    <para>
     输入 <command>crm configure</command> 切换到交互式 crm 外壳。
    </para>
   </step>
   <step xml:id="step-ha-geo-setup-rsc-constraints">
    <para>
     配置约束，用于定义哪些资源依赖于特定的票据。例如，需要为<xref linkend="sec-ha-geo-drbd-scenario"/>中所述的 DRBD 方案配置以下约束：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> nfs-req-ticket-nfs ticket-nfs: \ 
   ms_drbd_nfs:Master loss-policy=demote</screen>
    <para>
     此命令将创建 ID 为 <literal>nfs-req-ticket-nfs</literal> 的约束。该约束定义多状态资源 <literal>ms_drbd_nfs</literal> 依赖于 <literal>ticket-nfs</literal>。但是，只有资源的主模式依赖于该票据。如果已撤消 <literal>ticket-nfs</literal>，<literal>ms_drbd_nfs</literal> 将自动降级为<literal>从</literal>模式，从而将 DRBD 置于<literal>次要</literal>模式。这样，即使站点没有票据，也能确保 DRBD 复制仍可运行。
    </para>
   </step>
   <step>
    <para>
     如果希望其他资源依赖于其他票据，请使用 <command>rsc_ticket</command> 根据需要创建更多的约束。
    </para>
   </step>
   <step>
    <para>
     使用 <command>show</command> 复查更改。
    </para>
   </step>
   <step>
    <para>
     如果全部都正确，请使用 <command>commit</command> 提交更改，并使用 <command>exit</command> 退出 crm 当前配置。
    </para>
    <para>
     配置将保存到 CIB。
    </para>
   </step>
  </procedure>
  <example xml:id="ex-ha-geo-setup-rsc-ticket-dep">
   <title>原始资源的票据依赖性</title>
   <para>
    下面是使原始资源 <literal>rsc1</literal> 依赖于 <literal>ticketA</literal> 的另一个约束示例：
   </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> rsc1-req-ticketA ticketA: \
   rsc1 loss-policy="fence"</screen>
   <para>
    如果已撤消 <literal>ticketA</literal>，应屏蔽运行资源的节点。
   </para>
  </example>
  <procedure xml:id="pro-ha-geo-setup-rsc-boothd">
   <title>配置 <systemitem class="daemon">boothd</systemitem> 的资源组</title> 
   <para>
      每个站点都需要运行 <systemitem class="daemon">boothd</systemitem> 的一个实例以与其他 booth 守护程序通讯。该守护程序可以在任何节点上启动，因此应将其配置为原始资源。要使 <systemitem>boothd</systemitem> 资源保持在同一节点上，则在可行的情况下将资源粘性添加到配置中。每个守护程序都需要一个永久 IP 地址，因此请用虚拟 IP 地址配置另一个原始资源。将两个原始资源分组：</para> 
   <step>
    <para>
     在群集 <literal>amsterdam</literal> 的其中一个节点上，启动外壳并以 <systemitem class="username">root</systemitem> 或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     输入 <command>crm configure</command> 切换到交互式 crm 外壳。
    </para>
   </step>
   <step>
    <para>
     输入以下命令创建两个原始资源，并将它们添加到一个组 <literal>g-booth</literal>：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip-booth ocf:heartbeat:IPaddr2 \
  params iflabel="ha" nic="eth1" cidr_netmask="24"
  params rule #cluster-name eq amsterdam ip="192.168.201.151" \
  params rule #cluster-name eq berlin ip="192.168.202.151" 
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> booth ocf:pacemaker:booth-site \
  meta resource-stickiness="INFINITY" \
  params config="nfs" op monitor interval="10s"
<prompt role="custom">crm(live)configure# </prompt><command>group</command> g-booth ip-booth booth</screen>
    <para>
     通过这种配置，每个 booth 守护程序都将在各自的 IP 地址处可用，独立于运行守护程序的节点。
    </para>
   </step>
   <step>
    <para>
     使用 <command>show</command> 复查更改。
    </para>
   </step>
   <step>
    <para>
     如果全部都正确，请使用 <command>commit</command> 提交更改，并使用 <command>exit</command> 退出 crm 当前配置。
    </para>
    <para>
     配置将保存到 CIB。
    </para>
   </step>
  </procedure>

  <procedure xml:id="pro-ha-geo-setup-rsc-order">
   <title>添加排序约束</title> 
   <para>
      如果票据已授予某个站点，但因任何原因导致该站点的所有节点无法托管 <systemitem class="daemon">boothd</systemitem> 资源组，则可能导致分布于不同地理位置的站点之间出现<quote>节点分裂</quote>现象。在这种情况下，系统无法通过任何 <systemitem class="daemon">boothd</systemitem> 实例针对其他站点安全地管理票据故障转移。要避免该票据出现潜在的并发性违规（票据同时被授予多个站点），请添加一个排序约束。 
     </para>  
   <step>
    <para>
     在群集 amsterdam 的其中一个节点上，启动外壳并以 <systemitem class="username">root</systemitem> 或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     输入 <command>crm configure</command> 切换到交互式 crm 外壳。
    </para>
   </step>
   <step>
    <para>
     创建排序约束：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>order</command> o-booth-before-nfs inf: g-booth ms_drbd_nfs:promote</screen>
    <para>
     顺序约束 <literal>o-booth-before-nfs</literal> 定义只有在启动 <literal>g-booth</literal> 资源组后，才能将资源 <literal>ms_drbd_nfs</literal> 升级到主模式。
    </para>
   </step>
   <step>
    <para>
     对于取决于某种特定票据的其他任何资源，定义更多的排序约束。
    </para>
   </step>
   <step>
    <para>
     使用 <command>show</command> 复查更改。
    </para>
   </step>
   <step>
    <para>
     如果全部都正确，请使用 <command>commit</command> 提交更改，并使用 <command>exit</command> 退出 crm 当前配置。
    </para>
    <para>
     配置将保存到 CIB。
    </para>
   </step>
  </procedure>
  <example xml:id="ex-ha-geo-rsc-order">
   <title>原始资源的顺序约束</title>
   <para>
    如果依赖于特定票据的资源不是多状态资源而是原始资源，则顺序约束如下所示：
   </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>order</command> o-booth-before-rsc1 inf: g-booth rsc1</screen>
   <para>
    该约束定义 <literal>rsc1</literal>（依赖于 <literal>ticketA</literal>）只能在 <literal>g-booth</literal> 资源组之后启动。
   </para>
  </example>
 </sect2>

 <sect2 xml:id="sec-ha-geo-rsc-sync-cib">

  <title>将资源配置传输到其他群集站点</title>
  <para>
   仅仅是根据<xref linkend="sec-ha-geo-rsc-drbd" xrefstyle="select:label"/>和<xref linkend="sec-ha-geo-rsc-booth" xrefstyle="select:label"/>中所述为某个群集站点配置资源并不足够。还需要将资源配置传输到地域群集的其他站点。
  </para>
  <para>
   为了简化传输，可以标记<emphasis>所有</emphasis>群集站点上所需的任何资源，从当前 CIB 导出这些资源，然后将其导入另一站点的 CIB。<xref linkend="pro-ha-geo-rsc-sync-cib"/>中提供了操作方法的示例。完成此过程必须满足以下先决条件：
  </para>
  <itemizedlist>
   <title>先决条件</title>
   <listitem>
    <para>
     有一个包含两个站点的地域群集：群集 <literal>amsterdam</literal> 和群集 <literal>berlin</literal>。
    </para>
   </listitem>
   <listitem>
    <para>
     已在相应的 <filename>/etc/corosync/corosync.conf</filename> 文件中定义每个站点的群集名称。
    </para>
<screen>totem {
     [...]
     cluster_name: amsterdam
     }</screen>
    <para>
     可以手动完成此项定义（通过编辑 <filename>/etc/corosync/corosync.conf</filename>），也可以根据 <link xlink:href="http://www.suse.com/documentation/"/> 上的《<citetitle><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> <phrase role="productnumber"><phrase os="sles">12 SP2</phrase></phrase> 管理指南</citetitle>》中所述，使用 YaST 群集模块完成此项定义。请参见“<citetitle>安装和基本设置</citetitle>”一章中的过程“<citetitle>定义第一个通讯通道</citetitle>”。
    </para>
   </listitem>
   <listitem>
    <para>
     已按<xref linkend="sec-ha-geo-rsc-drbd"/>和<xref linkend="sec-ha-geo-rsc-booth"/>中所述，为 DRBD 和 booth 配置了所需的资源。
    </para>
   </listitem>
  </itemizedlist>
  <procedure xml:id="pro-ha-geo-rsc-sync-cib">
   <title>将资源配置传输到其他群集站点</title>
   <step>
    <para>
     登录到群集 <literal>amsterdam</literal> 的节点之一。
    </para>
   </step>
   <step>
    <para>
     使用以下命令启动群集：
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start pacemaker</screen>
   </step>
   <step>
    <para>
     输入 <command>crm configure</command> 切换到交互式 crm 外壳。
    </para>
   </step>
   <step>
    <para>
     标记整个地域群集上所需的资源和约束：
    </para>
    <substeps performance="required">
     <step>
      <para>
       查看当前 CIB 配置：
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt>show</screen>
     </step>
     <step>
      <para>
       输入以下命令，使用标记 <literal>geo_resources</literal> 来分组地域群集相关的资源：
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>tag</command> geo_resources: \
  ip_nfs nfs_fs nfs_service drbd_nfs drbd_nfs_lower ms_drbd_nfs \
  ms_drbd_nfs_lower g_nfs <co xml:id="co-geo-rsc-drbd"/>\
  col_nfs_ip_with_lower  col_nfs_g_with_upper col_nfs_upper_with_ip <xref linkend="co-geo-rsc-drbd" xrefstyle="select:label"/>\
  o_lower_drbd_before_ip_nfs o_ip_nfs_before_drbd \
  o_drbd_nfs_before_svc <xref linkend="co-geo-rsc-drbd" xrefstyle="select:label"/>\
  nfs-req-ticket-nfs ip-booth booth g-booth o-booth-before-nfs <co xml:id="co-geo-rsc-booth"/>
  [...] <co xml:id="co-geo-rsc-any"/></screen>
      <para>
       标记不会在资源之间创建任何共置或顺序关系。
      </para>
      <calloutlist>
       <callout arearefs="co-geo-rsc-drbd">
        <para>
         DRBD 的资源和约束，具体请参见<xref linkend="sec-ha-geo-rsc-drbd"/>。
        </para>
       </callout>
       <callout arearefs="co-geo-rsc-booth">
        <para>
         boothd 的资源和约束，具体请参见<xref linkend="sec-ha-geo-rsc-booth"/>。
        </para>
       </callout>
       <callout arearefs="co-geo-rsc-any">
        <para>
         需要在地域群集的所有站点上使用的特定设置的其他任何资源。
        </para>
       </callout>
      </calloutlist>
     </step>
     <step>
      <para>
       使用 <command>show</command> 查看更改。
      </para>
     </step>
     <step>
      <para>
       如果配置符合需要，请使用 <command>submit</command> 提交更改，然后使用 <command>exit</command> 退出 crm 在线外壳。
      </para>
     </step>
    </substeps>
   </step>
   <step xml:id="st-ha-geo-rsc-sync-cib-export-start">
    <para>
     将标记的资源和约束导出到名为 <filename>exported.cib</filename> 的文件：
    </para>
<screen><prompt role="root">root # </prompt><command>crm configure show</command> tag:geo_resources geo_resources &gt; exported.cib</screen>
    <para>
     命令 <command>crm configure show tag:</command><replaceable>标记名称</replaceable>将显示属于标记<replaceable>标记名称</replaceable>的所有资源。
    </para>
   </step>
   <step>
    <para>
     登录到群集 <literal>berlin</literal> 的节点之一并执行以下操作：
    </para>
    <substeps performance="required">
     <step>
      <para>
       使用以下命令启动群集：
      </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start pacemaker</screen>
     </step>
     <step>
      <para>
       将群集 <literal>amsterdam</literal> 中的文件 <filename>exported.cib</filename> 复制到此节点。<remark>taroth
        2014-11-26: alternatively, the CIB can be loaded from an URL - consider
        if to mention this, too</remark>
      </para>
     </step>
     <step>
      <para>
       将文件 <filename>exported.cib</filename> 中标记的资源和约束导入群集 <literal>berlin</literal> 的 CIB：
      </para>
<screen><prompt role="root">root # </prompt><command>crm configure load</command> update <replaceable>PATH_TO_FILE/exported.cib</replaceable></screen>
      <para>
       为 <command>crm configure load</command> 命令使用 <option>update</option> 参数时，crmsh 会尝试将文件内容集成到当前的 CIB 配置（而不是将当前 CIB 替换为文件内容）。
      </para>
     </step>
     <step xml:id="st-ha-geo-rsc-sync-cib-import-stop">
      <para>
       使用以下命令查看更新的 CIB 配置：
      </para>
<screen><prompt role="root">root # </prompt><command>crm configure show</command></screen>
      <para>
       导入的资源和约束将显示在 CIB 中。
      </para>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   使用此配置时，将发生以下情况：
  </para>
  <itemizedlist>
   <listitem>
    <para>
     向群集 <literal>amsterdam</literal> 授予 <literal>ticket-nfs</literal> 时，托管资源 <literal>ip_nfs</literal> 的节点将获取 IP 地址 <literal>192.168.201.151</literal>。
    </para>
   </listitem>
   <listitem>
    <para>
     向群集 <literal>berlin</literal> 授予 <literal>ticket-nfs</literal> 时，托管资源 <literal>ip_nfs</literal> 的节点将获取 IP 地址 <literal>192.168.202.151</literal>。
    </para>
   </listitem>
  </itemizedlist>
  <example xml:id="ex-ha-geo-rsc-refer-params">
   <title>在资源中参照站点相关的参数</title>
   <para>
    根据<xref linkend="pro-ha-geo-rsc-drbd" xrefstyle="select:label"/>中的示例，您还能够创建可参照其他资源的站点特定参数（例如 <literal>ip_nfs</literal> 的 IP 参数）的资源。按如下所示继续：
   </para>
   <orderedlist spacing="normal">
    <listitem>
     <para>
      在群集 <literal>amsterdam</literal> 上创建一个虚拟资源，该资源参照 <literal>ip_nfs</literal> 的 IP 参数，并使用这些参数作为其 <literal>state</literal> 参数的值：
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> dummy1 ocf:pacemaker:Dummy \
  params rule #cluster-name eq amsterdam \
  @ip_nfs-instance_attributes-0-ip:state \
  params rule #cluster-name eq berlin \
  @ip_nfs-instance_attributes-1-ip:state \
  op monitor interval=10</screen>
    </listitem>
    <listitem>
     <para>
      添加一个约束，使 <literal>dummy1</literal> 资源也依赖于 <literal>ticket-nfs</literal>：
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> dummy1-dep-ticket-nfs \
  ticket-nfs: dummy1 loss-policy=stop</screen>
    </listitem>
    <listitem>
     <para>
      标记资源和约束：
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>tag</command> geo_resources_2: dummy1 \
  dummy1-dep-ticket-nfs</screen>
    </listitem>
    <listitem>
     <para>
      使用 <command>show</command> 检查更改，使用 <command>submit</command> 提交更改，然后使用 <command>exit</command> 退出 crm 在线外壳。
     </para>
    </listitem>
    <listitem>
     <para>
      从群集 <literal>amsterdam</literal> 导出带有 <literal>geo_resources_2</literal> 标记的资源，然后将其导入群集 <literal>berlin</literal> 的 CIB，类似于<xref linkend="pro-ha-geo-rsc-sync-cib" xrefstyle="select:label"/> 中<xref linkend="st-ha-geo-rsc-sync-cib-export-start"/> 到<xref linkend="st-ha-geo-rsc-sync-cib-import-stop"/> 的操作。
     </para>
    </listitem>
   </orderedlist>
   <para>
    使用此配置时，将发生以下情况：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      向群集 <literal>amsterdam</literal> 授予 <literal>ticket-nfs</literal> 时，将在托管 <literal>dummy</literal> 资源的节点上创建以下文件：<filename>/var/lib/heartbeat/cores/192.168.201.151</filename>。
     </para>
    </listitem>
    <listitem>
     <para>
      向群集 <literal>berlin</literal> 授予 <literal>ticket-nfs</literal> 时，将在托管 <literal>dummy</literal> 资源的节点上创建以下文件：<filename>/var/lib/heartbeat/cores/192.168.202.151</filename>。
     </para>
    </listitem>
   </itemizedlist>
  </example>
 </sect2>
</sect1>
