<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_resources_i.xml" version="5.0" xml:id="sec-ha-geo-rsc">
 <title>Configurando recursos e restrições do cluster</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editando</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes (sim)</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>
  Além dos recursos e das restrições que você precisa definir para a configuração do cluster específico, os clusters Geo requerem outros recursos e restrições, conforme descrito a seguir. Você pode configurá-los com o shell do crm (crmsh), conforme demonstrado nos exemplos a seguir, ou com o HA Web Konsole (Hawk2).
 </para>

 <para>
  Esta seção dedica-se às tarefas específicas dos clusters Geo. Para obter uma introdução à ferramenta de gerenciamento de cluster de sua preferência e instruções gerais sobre como configurar recursos e restrições com ela, consulte um dos seguintes capítulos no <citetitle>Guia de Administração</citetitle> da <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>, disponível em <link xlink:href="http://www.suse.com/documentation/"/>:
 </para>

 <itemizedlist>
  <listitem>
   <para>
    Hawk2: Capítulo <citetitle>Configurando e gerenciando recursos de cluster (interface da Web)</citetitle>
   </para>
  </listitem>
  <listitem>
   <para>
    crmsh: Capítulo <citetitle>Configurando e gerenciando recursos de cluster (linha de comando)</citetitle>
   </para>
  </listitem>
 </itemizedlist>

 <important>
  <title>Não há sincronização do CIB entre os sites</title>
  <para>
   O CIB <emphasis>não</emphasis> é sincronizado automaticamente entre os sites de um cluster Geo. Isso significa que você precisa configurar todos os recursos que devem estar altamente disponíveis no cluster Geo para cada site adequadamente.
  </para>
  <para>
   Para simplificar a transferência da configuração para outros sites do cluster, quaisquer recursos com parâmetros específicos do site podem ser configurados de forma que os valores dos parâmetros dependam do nome do site do cluster no qual o recurso está sendo executado.
  </para>
  <para>
   Para que isso funcione, os nomes de cluster para cada site devem ser definidos nos respectivos arquivos <filename>/etc/corosync/corosync.conf</filename>. Por exemplo, o <filename>/etc/corosync/corosync.conf</filename> do site 1 (<literal>amsterdam</literal>) deve incluir a seguinte entrada:
  </para>
<screen>totem {
   [...]
   cluster_name: amsterdam
   }</screen>
  <para>
   Após configurar os recursos em um site, você poderá marcar os que são necessários em todos os sites do cluster, exportá-los do CIB atual e importá-los para o CIB de outro site do cluster. Para obter os detalhes, consulte a <xref linkend="sec-ha-geo-rsc-sync-cib"/>.
  </para>
 </important>

 <sect2 xml:id="sec-ha-geo-rsc-drbd">
  <title>Recursos e restrições do DRBD</title>
  <para>
   Para concluir a configuração do DRBD, você precisa configurar alguns recursos e restrições, conforme mostrado no <xref linkend="pro-ha-geo-rsc-drbd" xrefstyle="select:label"/>, e transferi-los para os outros sites do cluster, como explicado na <xref linkend="sec-ha-geo-rsc-sync-cib"/>.
  </para>
  <procedure xml:id="pro-ha-geo-rsc-drbd">
   <title>Configurando recursos para uma configuração do DRBD</title>
   <step>
    <para>
     Em um dos nós do cluster <literal>amsterdam</literal>, inicie um shell e efetue login como <systemitem class="username">root</systemitem> ou equivalente.
    </para>
   </step>
   <step>
    <para>
     Digite <command>crm configure</command> para alternar para o shell do crm interativo.
    </para>
   </step>
   <step>
    <para>
     Configure o IP do serviço (dependente do site) no NFS como um primitivo básico:
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip_nfs ocf:heartbeat:IPaddr2 \
  params iflabel="nfs" nic="eth1" cidr_netmask="24"
  params rule #cluster-name eq amsterdam ip="192.168.201.151" \
  params rule #cluster-name eq berlin ip="192.168.202.151" \
  op monitor interval=10</screen>
   </step>
   <step>
    <para>
     Configure um recurso do sistema de arquivos e um recurso para o servidor NFS:
    </para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> nfs_fs ocf:heartbeat:Filesystem \
  params device="/dev/drbd/by-res/nfs/0" directory="/mnt/nfs" \
  fstype="ext4"
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> nfs_service systemd:nfs-server</screen>
   </step>
   <step>
    <para>
     Configure os seguintes recursos primitivos e de vários estados no DRBD:
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> drbd_nfs ocf:linbit:drbd \
  params drbd_resource="nfs-upper" \
  op monitor interval="31" role="Slave" \
  op monitor interval="30" role="Master"
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> drbd_nfs_lower ocf:linbit:drbd \
  params rule #cluster-name eq amsterdam \
  drbd_resource="nfs-lower-amsterdam" \
  params rule #cluster-name eq berlin \
  drbd_resource="nfs-lower-berlin" \                                
  op monitor interval="31" role="Slave" \
  op monitor interval="30" role="Master"
<prompt role="custom">crm(live)configure# </prompt><command>ms</command> ms_drbd_nfs drbd_nfs \
  meta master-max="1" master-node-max="1" \
  clone-max="1" clone-node-max="1" notify="true"
<prompt role="custom">crm(live)configure# </prompt><command>ms</command> ms_drbd_nfs_lower drbd_nfs_lower \
  meta master-max="1" master-node-max="1" \
  clone-max="2" clone-node-max="1" notify="true"</screen>
   </step>
   <step>
    <para>
     Adicione um grupo com as seguintes restrições de colocation e ordem:
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>group</command> g_nfs nfs_fs nfs_service
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_ip_with_lower \
   inf: ip_nfs:Started  ms_drbd_nfs_lower:Master
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_g_with_upper \
   inf: g_nfs:Started  ms_drbd_nfs:Master
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_upper_with_ip \
   inf: ms_drbd_nfs:Master  ip_nfs:Started
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_lower_drbd_before_ip_nfs \
   inf: ms_drbd_nfs_lower:promote  ip_nfs:start
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_ip_nfs_before_drbd \
   inf: ip_nfs:start  ms_drbd_nfs:promote
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_drbd_nfs_before_svc \
   inf: ms_drbd_nfs:promote  g_nfs:start</screen>
   </step>
   <step>
    <para>
     Use o comando <command>show</command> para revisar suas mudanças.
    </para>
   </step>
   <step>
    <para>
     Se tudo estiver correto, use o comando <command>commit</command> para enviar suas mudanças e saia da configuração do crm live com <command>exit</command>.
    </para>
    <para>
     A configuração é gravada no CIB.
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-ha-geo-rsc-booth">
  <title>Dependências de ticket, restrições e recursos de booth</title>
  <para>
   Para concluir a configuração de booth, você precisa executar as seguintes etapas para definir os recursos e as restrições necessários para booth e failover de recursos:
  </para>
  <itemizedlist>
   <listitem>
    <para>

     <xref linkend="pro-ha-geo-setup-rsc-constraints" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>

     <xref linkend="pro-ha-geo-setup-rsc-boothd" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>

     <xref linkend="pro-ha-geo-setup-rsc-order" xrefstyle="select:title"/>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   As configurações de recurso precisam estar disponíveis em cada um dos sites do cluster. Transfira-as para os outros sites, conforme descrito na <xref linkend="sec-ha-geo-rsc-sync-cib"/>.
  </para>
  <procedure xml:id="pro-ha-geo-setup-rsc-constraints">
   <title>Configurando dependências de ticket dos recursos</title>
   <para>
     Para os clusters Geo, você pode especificar quais recursos dependem de um determinado ticket. Juntamente com esse tipo especial de restrição, você pode definir uma <literal>loss-policy</literal> que especifica o que deverá acontecer com os respectivos recursos se o ticket for revogado. O atributo <literal>loss-policy</literal> pode ter os seguintes valores:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <literal>fence</literal>: Limita os nós que executam os recursos relevantes.
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>stop</literal>: Para os recursos relevantes.
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>freeze</literal>: Não faz nada com os recursos relevantes.
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>demote</literal>: Retrocede os recursos relevantes que são executados no modo <literal>master</literal> para o modo <literal>slave</literal>.
      </para>
     </listitem>
    </itemizedlist> 
   <step>
    <para>
     Em um dos nós do cluster amsterdam, inicie um shell e efetue login como <systemitem class="username">root</systemitem> ou equivalente.

    </para>
   </step>
   <step>
    <para>
     Digite <command>crm configure</command> para alternar para o shell do crm interativo.
    </para>
   </step>
   <step xml:id="step-ha-geo-setup-rsc-constraints">
    <para>
     Configure restrições que definam quais recursos dependem de um determinado ticket. Por exemplo, precisamos da seguinte restrição para o cenário do DRBD descrito na <xref linkend="sec-ha-geo-drbd-scenario"/>:
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> nfs-req-ticket-nfs ticket-nfs: \ 
   ms_drbd_nfs:Master loss-policy=demote</screen>
    <para>
     Esse comando cria uma restrição com o ID <literal>nfs-req-ticket-nfs</literal>. Ele define que o recurso de vários estados <literal>ms_drbd_nfs</literal> depende do <literal>ticket-nfs</literal>. No entanto, apenas o modo master do recurso depende do ticket. Se o <literal>ticket-nfs</literal> for revogado, o <literal>ms_drbd_nfs</literal> será automaticamente retrocedido para o modo <literal>slave</literal>, que, por sua vez, colocará o DRBD no modo <literal>Secondary</literal>. Dessa forma, há uma garantia de que a replicação do DRBD ainda esteja em execução, mesmo que um site não tenha o ticket.
    </para>
   </step>
   <step>
    <para>
     Para que outros recursos dependam de mais tickets, crie quantas restrições forem necessárias com o comando <command>rsc_ticket</command>.
    </para>
   </step>
   <step>
    <para>
     Use o comando <command>show</command> para revisar suas mudanças.
    </para>
   </step>
   <step>
    <para>
     Se tudo estiver correto, use o comando <command>commit</command> para enviar suas mudanças e saia da configuração do crm live com <command>exit</command>.
    </para>
    <para>
     A configuração é gravada no CIB.
    </para>
   </step>
  </procedure>
  <example xml:id="ex-ha-geo-setup-rsc-ticket-dep">
   <title>Dependência de ticket para primitivos</title>
   <para>
    Este é outro exemplo de uma restrição que torna o recurso primitivo <literal>rsc1</literal> dependente do <literal>ticketA</literal>:
   </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> rsc1-req-ticketA ticketA: \
   rsc1 loss-policy="fence"</screen>
   <para>
    Se o <literal>ticketA</literal> for revogado, o nó que executa o recurso deverá ser limitado.
   </para>
  </example>
  <procedure xml:id="pro-ha-geo-setup-rsc-boothd">
   <title>Configurando um grupo de recursos para o <systemitem class="daemon">boothd</systemitem></title> 
   <para>
      Cada site precisa executar uma instância do <systemitem class="daemon">boothd</systemitem> que se comunique com os outros daemons de booth. O daemon pode ser iniciado em qualquer nó, portanto, ele deve ser configurado como um recurso primitivo. Para fazer com que o recurso <systemitem>boothd</systemitem> permaneça no mesmo nó, se possível, adicione a permanência do recurso à configuração. Como cada daemon precisa de um endereço IP persistente, configure outro primitivo com um endereço IP virtual. Agrupe os dois primitivos:</para> 
   <step>
    <para>
     Em um dos nós do cluster <literal>amsterdam</literal>, inicie um shell e efetue login como <systemitem class="username">root</systemitem> ou equivalente.
    </para>
   </step>
   <step>
    <para>
     Digite <command>crm configure</command> para alternar para o shell do crm interativo.
    </para>
   </step>
   <step>
    <para>
     Digite o seguinte para criar os dois recursos primitivos e adicioná-los a um grupo <literal>g-booth</literal>:
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip-booth ocf:heartbeat:IPaddr2 \
  params iflabel="ha" nic="eth1" cidr_netmask="24"
  params rule #cluster-name eq amsterdam ip="192.168.201.151" \
  params rule #cluster-name eq berlin ip="192.168.202.151" 
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> booth ocf:pacemaker:booth-site \
  meta resource-stickiness="INFINITY" \
  params config="nfs" op monitor interval="10s"
<prompt role="custom">crm(live)configure# </prompt><command>group</command> g-booth ip-booth booth</screen>
    <para>
     Com essa configuração, cada daemon de booth está disponível em seu endereço IP individual, independentemente do nó em que o daemon é executado.
    </para>
   </step>
   <step>
    <para>
     Use o comando <command>show</command> para revisar suas mudanças.
    </para>
   </step>
   <step>
    <para>
     Se tudo estiver correto, use o comando <command>commit</command> para enviar suas mudanças e saia da configuração do crm live com <command>exit</command>.
    </para>
    <para>
     A configuração é gravada no CIB.
    </para>
   </step>
  </procedure>

  <procedure xml:id="pro-ha-geo-setup-rsc-order">
   <title>Adicionando uma restrição de ordem</title> 
   <para>
      Se um ticket foi concedido a um site, mas todos os nós desse site não podem hospedar o grupo de recursos <systemitem class="daemon">boothd</systemitem> por qualquer motivo, uma situação de <quote>split brain</quote> pode ocorrer entre os sites distribuídos geograficamente. Nesse caso, nenhuma instância de <systemitem class="daemon">boothd</systemitem> estaria disponível para gerenciar com segurança o failover do ticket para outro site. Para evitar uma possível violação de simultaneidade do ticket (o ticket é concedido para vários sites ao mesmo tempo), adicione uma restrição de ordem: 
     </para>  
   <step>
    <para>
     Em um dos nós do cluster amsterdam, inicie um shell e efetue login como <systemitem class="username">root</systemitem> ou equivalente.
    </para>
   </step>
   <step>
    <para>
     Digite <command>crm configure</command> para alternar para o shell do crm interativo.
    </para>
   </step>
   <step>
    <para>
     Crie uma restrição de ordem:
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>order</command> o-booth-before-nfs inf: g-booth ms_drbd_nfs:promote</screen>
    <para>
     A restrição de ordem <literal>o-booth-before-nfs</literal> define que o recurso <literal>ms_drbd_nfs</literal> apenas poderá ser promovido para o modo master depois que o grupo de recursos <literal>g-booth</literal> for iniciado.
    </para>
   </step>
   <step>
    <para>
     Para qualquer outro recurso que dependa de um determinado ticket, defina mais restrições de ordem.
    </para>
   </step>
   <step>
    <para>
     Use o comando <command>show</command> para revisar suas mudanças.
    </para>
   </step>
   <step>
    <para>
     Se tudo estiver correto, use o comando <command>commit</command> para enviar suas mudanças e saia da configuração do crm live com <command>exit</command>.
    </para>
    <para>
     A configuração é gravada no CIB.
    </para>
   </step>
  </procedure>
  <example xml:id="ex-ha-geo-rsc-order">
   <title>Restrição de ordem para primitivos</title>
   <para>
    Se o recurso dependente de um determinado ticket não for um recurso de vários estados, mas um primitivo, a restrição de ordem será semelhante ao seguinte:
   </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>order</command> o-booth-before-rsc1 inf: g-booth rsc1</screen>
   <para>
    Define que <literal>rsc1</literal> (que depende do <literal>ticketA</literal>) apenas poderá ser iniciado após o grupo de recursos <literal>g-booth</literal>.
   </para>
  </example>
 </sect2>

 <sect2 xml:id="sec-ha-geo-rsc-sync-cib">

  <title>Transferindo a configuração de recursos para outros sites de cluster</title>
  <para>
   Se você configurou recursos para um site do cluster, conforme descrito na <xref linkend="sec-ha-geo-rsc-drbd" xrefstyle="select:label"/> e na <xref linkend="sec-ha-geo-rsc-booth" xrefstyle="select:label"/>, ainda não terminou. Você precisa transferir a configuração de recursos para os outros sites do cluster Geo.
  </para>
  <para>
   Para simplificar a transferência, você pode marcar quaisquer recursos que sejam necessários em <emphasis>todos</emphasis> os sites do cluster, exportá-los do CIB atual e importá-los para o CIB de outro site do cluster. O <xref linkend="pro-ha-geo-rsc-sync-cib"/> mostra um exemplo de como fazer isso. Ele se baseia nos seguintes pré-requisitos:
  </para>
  <itemizedlist>
   <title>Pré-requisitos</title>
   <listitem>
    <para>
     Você tem um cluster Geo com dois sites: cluster <literal>amsterdam</literal> e cluster <literal>berlin</literal>.
    </para>
   </listitem>
   <listitem>
    <para>
     Os nomes dos clusters de cada site são definidos nos respectivos arquivos <filename>/etc/corosync/corosync.conf</filename>:
    </para>
<screen>totem {
     [...]
     cluster_name: amsterdam
     }</screen>
    <para>
     Isso pode ser feito manualmente (editando o <filename>/etc/corosync/corosync.conf</filename>) ou com o módulo de cluster do YaST, conforme descrito no <citetitle>Guia de Administração</citetitle> da <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> <phrase role="productnumber"><phrase os="sles">12 SP2</phrase></phrase>, disponível em <link xlink:href="http://www.suse.com/documentation/"/>. Consulte o capítulo <citetitle>Instalação e configuração básica</citetitle>, procedimento <citetitle>Definindo o primeiro canal de comunicação</citetitle>.
    </para>
   </listitem>
   <listitem>
    <para>
     Você configurou os recursos necessários ao DRBD e booth conforme descrito na <xref linkend="sec-ha-geo-rsc-drbd"/> e na <xref linkend="sec-ha-geo-rsc-booth"/>.
    </para>
   </listitem>
  </itemizedlist>
  <procedure xml:id="pro-ha-geo-rsc-sync-cib">
   <title>Transferindo a configuração de recursos para outros sites de cluster</title>
   <step>
    <para>
     Efetue login em um dos nós do cluster <literal>amsterdam</literal>.
    </para>
   </step>
   <step>
    <para>
     Inicie o cluster com:
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start pacemaker</screen>
   </step>
   <step>
    <para>
     Digite <command>crm configure</command> para alternar para o shell do crm interativo.
    </para>
   </step>
   <step>
    <para>
     Marque os recursos e as restrições que são necessários no cluster Geo:
    </para>
    <substeps performance="required">
     <step>
      <para>
       Revise a configuração do CIB atual:
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt>show</screen>
     </step>
     <step>
      <para>
       Digite o seguinte comando para agrupar os recursos relacionados ao cluster Geo com a tag <literal>geo_resources</literal>:
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>tag</command> geo_resources: \
  ip_nfs nfs_fs nfs_service drbd_nfs drbd_nfs_lower ms_drbd_nfs \
  ms_drbd_nfs_lower g_nfs <co xml:id="co-geo-rsc-drbd"/>\
  col_nfs_ip_with_lower  col_nfs_g_with_upper col_nfs_upper_with_ip <xref linkend="co-geo-rsc-drbd" xrefstyle="select:label"/>\
  o_lower_drbd_before_ip_nfs o_ip_nfs_before_drbd \
  o_drbd_nfs_before_svc <xref linkend="co-geo-rsc-drbd" xrefstyle="select:label"/>\
  nfs-req-ticket-nfs ip-booth booth g-booth o-booth-before-nfs <co xml:id="co-geo-rsc-booth"/>
  [...] <co xml:id="co-geo-rsc-any"/></screen>
      <para>
       A marcação não cria nenhum relacionamento de colocation ou ordem entre os recursos.
      </para>
      <calloutlist>
       <callout arearefs="co-geo-rsc-drbd">
        <para>
         Recursos e restrições do DRBD. Consulte a <xref linkend="sec-ha-geo-rsc-drbd"/>.
        </para>
       </callout>
       <callout arearefs="co-geo-rsc-booth">
        <para>
         Recursos e restrições do boothd. Consulte a <xref linkend="sec-ha-geo-rsc-booth"/>.
        </para>
       </callout>
       <callout arearefs="co-geo-rsc-any">
        <para>
         Quaisquer outros recursos de sua configuração específica que sejam necessários em todos os sites do cluster Geo.
        </para>
       </callout>
      </calloutlist>
     </step>
     <step>
      <para>
       Use o comando <command>show</command> para revisar suas mudanças.
      </para>
     </step>
     <step>
      <para>
       Se a configuração estiver de acordo com as suas preferências, envie as mudanças usando o comando <command>submit</command> e saia do shell do crm live com o comando <command>exit</command>.
      </para>
     </step>
    </substeps>
   </step>
   <step xml:id="st-ha-geo-rsc-sync-cib-export-start">
    <para>
     Exporte os recursos e restrições marcados para um arquivo denominado <filename>exported.cib</filename>:
    </para>
<screen><prompt role="root">root # </prompt><command>crm configure show</command> tag:geo_resources geo_resources &gt; exported.cib</screen>
    <para>
     O comando <command>crm configure show tag:</command><replaceable>NOMEDATAG</replaceable> mostra todos os recursos que pertencem à tag <replaceable>NOMEDATAG</replaceable>.
    </para>
   </step>
   <step>
    <para>
     Efetue login em um dos nós do cluster <literal>berlin</literal> e faça o seguinte:
    </para>
    <substeps performance="required">
     <step>
      <para>
       Inicie o cluster com:
      </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start pacemaker</screen>
     </step>
     <step>
      <para>
       Copie o arquivo <filename>exported.cib</filename> do cluster <literal>amsterdam</literal> para esse nó. <remark>taroth
        2014-11-26: alternatively, the CIB can be loaded from an URL - consider
        if to mention this, too</remark>
      </para>
     </step>
     <step>
      <para>
       Importe os recursos e restrições marcados do arquivo <filename>exported.cib</filename> para o CIB do cluster <literal>berlin</literal>:
      </para>
<screen><prompt role="root">root # </prompt><command>crm configure load</command> update <replaceable>PATH_TO_FILE/exported.cib</replaceable></screen>
      <para>
       Ao usar o parâmetro <option>update</option> para o comando <command>crm configure load</command>, o crmsh tenta integrar o conteúdo do arquivo à configuração do CIB atual (em vez de substituir o conteúdo do CIB atual pelo conteúdo do arquivo).
      </para>
     </step>
     <step xml:id="st-ha-geo-rsc-sync-cib-import-stop">
      <para>
       Veja a configuração do CIB atualizada com o seguinte comando:
      </para>
<screen><prompt role="root">root # </prompt><command>crm configure show</command></screen>
      <para>
       Os recursos e restrições importados também são exibidos no CIB.
      </para>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   Essa configuração resulta no seguinte:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     Ao conceder o <literal>ticket-nfs</literal> ao cluster <literal>amsterdam</literal>, o nó que hospeda o recurso <literal>ip_nfs</literal> obtém o endereço IP <literal>192.168.201.151</literal>.
    </para>
   </listitem>
   <listitem>
    <para>
     Ao conceder o <literal>ticket-nfs</literal> ao cluster <literal>berlin</literal>, o nó que hospeda o recurso <literal>ip_nfs</literal> obtém o endereço IP <literal>192.168.202.151</literal>.
    </para>
   </listitem>
  </itemizedlist>
  <example xml:id="ex-ha-geo-rsc-refer-params">
   <title>Fazendo referência a parâmetros dependentes do site em recursos</title>
   <para>
    Com base no exemplo do <xref linkend="pro-ha-geo-rsc-drbd" xrefstyle="select:label"/>, você também pode criar recursos que fazem referência a parâmetros específicos do site de outro recurso, por exemplo, os parâmetros de IP do <literal>ip_nfs</literal>. Proceda da seguinte maneira:
   </para>
   <orderedlist spacing="normal">
    <listitem>
     <para>
      No cluster <literal>amsterdam</literal>, crie um recurso simulado que faça referência aos parâmetros de IP do <literal>ip_nfs</literal> e use-os como o valor do parâmetro <literal>state</literal>:
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> dummy1 ocf:pacemaker:Dummy \
  params rule #cluster-name eq amsterdam \
  @ip_nfs-instance_attributes-0-ip:state \
  params rule #cluster-name eq berlin \
  @ip_nfs-instance_attributes-1-ip:state \
  op monitor interval=10</screen>
    </listitem>
    <listitem>
     <para>
      Adicione uma restrição para tornar o recurso <literal>dummy1</literal> também dependente do <literal>ticket-nfs</literal>:
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> dummy1-dep-ticket-nfs \
  ticket-nfs: dummy1 loss-policy=stop</screen>
    </listitem>
    <listitem>
     <para>
      Marque o recurso e a restrição:
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>tag</command> geo_resources_2: dummy1 \
  dummy1-dep-ticket-nfs</screen>
    </listitem>
    <listitem>
     <para>
      Revise suas mudanças com o comando <command>show</command>, envie-as usando o comando <command>submit</command> e saia do shell do crm live com <command>exit</command>.
     </para>
    </listitem>
    <listitem>
     <para>
      Exporte os recursos marcados com <literal>geo_resources_2</literal> do cluster <literal>amsterdam</literal> e importe-os para o CIB do cluster <literal>berlin</literal>, semelhante à <xref linkend="st-ha-geo-rsc-sync-cib-export-start"/> até a <xref linkend="st-ha-geo-rsc-sync-cib-import-stop"/> do <xref linkend="pro-ha-geo-rsc-sync-cib" xrefstyle="select:label"/>.
     </para>
    </listitem>
   </orderedlist>
   <para>
    Essa configuração resulta no seguinte:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Ao conceder o <literal>ticket-nfs</literal> ao cluster <literal>amsterdam</literal>, o seguinte arquivo é criado no nó que hospeda o recurso <literal>dummy</literal>: <filename>/var/lib/heartbeat/cores/192.168.201.151</filename>.
     </para>
    </listitem>
    <listitem>
     <para>
      Ao conceder o <literal>ticket-nfs</literal> ao cluster <literal>berlin</literal>, o seguinte arquivo é criado no nó que hospeda o recurso <literal>dummy</literal>: <filename>/var/lib/heartbeat/cores/192.168.202.151</filename>.
     </para>
    </listitem>
   </itemizedlist>
  </example>
 </sect2>
</sect1>
